<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">

<!-- FIX ZOOM iOS -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>PANEL MRX</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<link rel="apple-touch-icon" href="apple-touch-icon.png">

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,system-ui;
  color:#fff;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
  background:#000;
  overflow:hidden;
}
#bgImage{
  position:fixed; inset:0;
  width:100%; height:100%;
  object-fit:cover;
  filter:blur(10px);
  opacity:.55;
  z-index:-1;
}
.panel{
  width:90%; max-width:360px;
  padding:26px 22px;
  border-radius:28px;
  background:rgba(0,0,0,.22);
  backdrop-filter:blur(18px);
  border:1px solid rgba(255,255,255,.12);
  position:relative;
  box-shadow:0 0 60px rgba(0,224,255,.08);
}
h1{text-align:center;margin:0;letter-spacing:1px}
.subtitle{text-align:center;font-size:12px;opacity:.7;margin-bottom:18px}
.avatar{display:flex;justify-content:center;margin-bottom:18px}
.avatar img{
  width:96px;height:96px;border-radius:50%;
  border:2px solid #00e0ff;
  box-shadow:0 0 25px #00e0ff
}
label{font-size:12px;opacity:.8}
select,input{
  width:80%;
  padding:12px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.1);
  background:rgba(0,0,0,.3);
  color:#fff;
  margin:6px auto 14px;
  display:block;
  font-size:16px;
}
button{
  width:90%;
  padding:14px;
  border-radius:22px;
  border:none;
  background:linear-gradient(135deg,#00e0ff,#7b3fe4);
  color:#fff;
  font-weight:600;
  cursor:pointer;
}
button:active{transform:scale(.97)}
.loader{
  display:none;margin:14px auto;
  width:28px;height:28px;border-radius:50%;
  border:4px solid rgba(255,255,255,.2);
  border-top-color:#00e0ff;
  animation:spin 1s linear infinite
}
@keyframes spin{to{transform:rotate(360deg)}}
.console{
  display:none;margin:14px auto 0;width:90%;
  max-height:140px;overflow:auto;
  background:rgba(0,0,0,.3);
  border-radius:14px;padding:10px;
  font-family:monospace;font-size:12px;color:#0ff
}

/* MODAL PRINCIPAL */
.modal{
  position:fixed;inset:0;
  background:rgba(0,0,0,.45);
  display:flex;justify-content:center;align-items:center;
  opacity:0;pointer-events:none;transition:.2s;
  z-index:9998;
}
.modal.show{opacity:1;pointer-events:auto}
.modal-box{
  width:90%;max-width:320px;
  background:rgba(0,0,0,.28);
  backdrop-filter:blur(16px);
  border-radius:22px;padding:22px;text-align:center;
  border:1px solid rgba(255,255,255,.12);
  box-shadow:0 0 40px rgba(0,224,255,.08);
}
.modal-box p{white-space:pre-line;font-size:14px}

/* REDES */
.footer{margin-top:26px}
.footer b{font-size:12px}
.social{
  margin-top:16px;
  display:flex;
  flex-direction:column;
  gap:18px;

  /* ‚úÖ scroll cuando agregues m√°s */
  max-height:220px;
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
  padding-right:6px;
}
.social::-webkit-scrollbar{width:6px;}
.social::-webkit-scrollbar-thumb{background:rgba(255,255,255,.18);border-radius:10px;}

.social-card{
  display:flex;justify-content:space-between;align-items:center;
  padding:18px 16px;border-radius:24px;
  background:rgba(0,0,0,.28);
  border:1px solid rgba(255,255,255,.10);
}
.contact-block{display:flex;align-items:center;gap:14px}
.icon{
  width:40px;height:40px;border-radius:50%;
  display:flex;justify-content:center;align-items:center
}
.icon img{width:22px}
.icon.tg{background:#0088cc}
.icon.wa{background:#25D366}
.contact-info{font-size:12px;line-height:1.25}
.role{font-size:10px;opacity:.6}
.handle a{color:#fff;text-decoration:none;font-weight:600}

/* ===== AVISO INSTALACI√ìN ===== */
#installModal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.65);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:9999;
}
.install-card{
  background:#fff;
  color:#222;
  width:92%;
  max-width:360px;
  border-radius:22px;
  padding:22px;
  text-align:center;
}
.install-card h3{margin:0;color:#21c7b7}
.install-sub{font-size:14px;margin:10px 0 16px}
.install-steps{text-align:left;font-size:14px;line-height:1.6}
.install-img{margin:16px 0;display:flex;justify-content:center}
.install-img img{width:180px;border-radius:14px}
.install-note{font-size:12px;color:#666;margin-top:10px}
.install-btn{
  margin-top:16px;width:100%;padding:12px;border:none;border-radius:14px;
  background:#25D366;color:#fff;font-weight:600
}

/* ===== TOP BAR BUTTONS ===== */
.top-left, .top-right{
  position:absolute;
  top:14px;
  z-index:5;
}
.top-left{ left:14px; }
.top-right{ right:14px; }

.icon-btn{
  width:44px;height:44px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.28);
  backdrop-filter:blur(14px);
  color:#fff;
  display:flex;
  justify-content:center;
  align-items:center;
  cursor:pointer;
  user-select:none;
}
.icon-btn:active{ transform:scale(.97); }

/* ===== MENU MODAL (HAMBURGER) ===== */
#menuModal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  justify-content:center;
  align-items:flex-start;
  padding-top:80px;
  z-index:9997;
}
.menu-card{
  width:92%;
  max-width:360px;
  border-radius:22px;
  padding:18px;
  background:rgba(0,0,0,.35);
  backdrop-filter:blur(18px);
  border:1px solid rgba(255,255,255,.12);
  box-shadow:0 0 50px rgba(123,63,228,.12);
}
.menu-title{
  font-weight:900;
  text-align:center;
  margin-bottom:10px;
  letter-spacing:1px;
}
.menu-close{
  margin-top:12px;
  width:100%;
  background:#333;
}
.hr{
  height:1px;
  background:rgba(255,255,255,.12);
  margin:12px 0;
}

/* Tools blocks inside menu */
.tools{ display:none; }

/* ‚úÖ inputs m√°s cortos en admin/owner */
.tools input{
  width:100%;
  max-width:300px;
  margin:6px auto 12px;
  display:block;
}

.tools button{ width:100%; }

.small{
  font-size:12px;
  opacity:.85;
  text-align:center;
  margin-top:10px;
}

/* ===== RECHARGE MODAL ===== */
#rechargeModal .modal-box{
  text-align:left;
}
.recharge-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:8px;
}
.recharge-title{
  font-weight:900;
  font-size:16px;
}
.recharge-sub{ opacity:.85; margin-top:6px; }

/* ‚úÖ scroll cuando agregues m√°s */
.recharge-links{
  margin-top:12px;
  display:flex;
  flex-direction:column;
  gap:10px;

  max-height:280px;
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
  padding-right:6px;
}
.recharge-links::-webkit-scrollbar{width:6px;}
.recharge-links::-webkit-scrollbar-thumb{
  background:rgba(255,255,255,.18);
  border-radius:10px;
}

.recharge-link{
  display:flex;
  align-items:center;
  gap:10px;
  padding:12px 12px;
  border-radius:16px;
  background:rgba(0,0,0,.35);
  border:1px solid rgba(255,255,255,.12);
  text-decoration:none;
  color:#fff;
}
.recharge-link img{ width:18px; height:18px; }
.recharge-link:active{ transform:scale(.99); }

/* chips cyber */
.badge-chip{
  margin-left:auto;
  opacity:.7;
  font-size:12px;
}

/* ===== mini glow lines ===== */
.glowline{
  height:1px;
  background:linear-gradient(90deg,transparent,rgba(0,224,255,.35),transparent);
  margin:10px 0;
}
</style>
</head>

<body>

<img src="fondo.jpg" id="bgImage">

<div class="panel">

  <!-- TOP LEFT: LOGOUT -->
  <div class="top-left">
    <div class="icon-btn" id="logoutBtn" title="Cerrar sesi√≥n">‚éã</div>
  </div>

  <!-- TOP RIGHT: HAMBURGER -->
  <div class="top-right">
    <div class="icon-btn" id="menuBtn" title="Men√∫">‚â°</div>
  </div>

  <h1>PANEL MRX</h1>

  <!-- Cr√©ditos arriba -->
  <div id="creditsBox" style="margin-top:6px;text-align:center;font-size:13px;opacity:.85;">
    üí≥ Cr√©ditos: <b id="creditsValue">0</b>
  </div>

  <div id="roleStatus" style="margin-top:4px;text-align:center;font-size:12px;opacity:.8;">
    üë§ Rol: <b id="roleValue">cargando...</b>
  </div>

  <div class="glowline"></div>

  <div class="subtitle">BAN WHATSAPP</div>

  <div class="avatar"><img src="avatar.jpg"></div>

  <label>PA√çS</label>
  <select id="pais">
    <option value="+51" selected>üáµüá™ Per√∫</option>
    <option value="+1">üá∫üá∏ USA</option>
    <option value="+52">üá≤üáΩ M√©xico</option>
    <option value="+54">üá¶üá∑ Argentina</option>
    <option value="+55">üáßüá∑ Brasil</option>
    <option value="+56">üá®üá± Chile</option>
    <option value="+57">üá®üá¥ Colombia</option>
    <option value="+34">üá™üá∏ Espa√±a</option>
    <option value="+44">üá¨üáß Reino Unido</option>
    <option value="+49">üá©üá™ Alemania</option>
    <option value="+33">üá´üá∑ Francia</option>
  </select>

  <label>N√öMERO</label>
  <input type="tel" id="numero" placeholder="Ingresa el n√∫mero" inputmode="numeric">

  <button id="execute">BANEAR</button>

  <div class="loader" id="loader"></div>
  <div class="console" id="console"></div>

  <div class="footer">
    <b>üì≤ REDES SOCIALES</b>

    <div class="social" id="socialList">
      <!-- Se llena por JS -->
    </div>
  </div>
</div>

<!-- MODAL PRINCIPAL -->
<div class="modal" id="modal">
  <div class="modal-box">
    <p id="modalText"></p>
    <button id="okBtn">OK</button>
  </div>
</div>

<!-- MODAL RECARGA (SIN CR√âDITOS) -->
<div class="modal" id="rechargeModal">
  <div class="modal-box" style="position:relative;">
    <div class="recharge-head">
      <div class="recharge-title">‚ùå No tienes suficientes cr√©ditos</div>
      <div style="opacity:.7;font-weight:700;">RECHARGE</div>
    </div>

    <div class="recharge-sub">Recarga con:</div>

    <div class="recharge-links" id="rechargeList">
      <!-- Se llena por JS -->
    </div>

    <button id="rechargeOk" style="margin-top:14px;width:100%;">CERRAR</button>
  </div>
</div>

<!-- MODAL MEN√ö (‚ò∞) -->
<div id="menuModal">
  <div class="menu-card">
    <div class="menu-title">MEN√ö</div>

    <div style="text-align:center;font-size:12px;opacity:.85;">
      üí≥ <b id="menuCredits">0</b> cr√©ditos ‚Ä¢ üë§ <b id="menuRole">user</b>
    </div>

    <div class="hr"></div>

    <!-- OWNER TOOLS -->
    <div class="tools" id="ownerTools">
      <div style="text-align:center;font-weight:900;margin-bottom:10px;">
        üëë PANEL OWNER
        <span id="notifBadge" style="display:none;margin-left:8px;padding:2px 8px;border-radius:999px;background:#00e0ff;color:#000;font-size:12px;">0</span>
      </div>

      <input id="ownerEmail" type="email" placeholder="Correo del usuario">
      <input id="ownerAmount" type="number" placeholder="Cr√©ditos (n√∫mero)" inputmode="numeric">

      <button id="ownerGiveBtn">DAR CR√âDITOS</button>

      <button id="ownerRemoveBtn" style="margin-top:8px;background:linear-gradient(135deg,#ff3b3b,#7b3fe4);">
        QUITAR CR√âDITOS
      </button>

      <button id="makeAdminBtn" style="margin-top:12px;background:linear-gradient(135deg,#00e0ff,#21c7b7);">
        DAR ADMIN
      </button>

      <button id="removeAdminBtn" style="margin-top:8px;background:linear-gradient(135deg,#ffb000,#7b3fe4);">
        QUITAR ADMIN
      </button>

      <button id="loadEventsBtn" style="margin-top:12px;background:#333;">
        VER NOTIFICACIONES
      </button>

      <div id="eventsBox" style="margin-top:10px;font-family:monospace;font-size:12px;white-space:pre-line;max-height:160px;overflow:auto;"></div>

      <div id="ownerMsg" class="small"></div>
    </div>

    <!-- ADMIN TOOLS -->
    <div class="tools" id="adminTools">
      <div style="text-align:center;font-weight:900;margin-bottom:10px;">üõ†Ô∏è PANEL ADMIN</div>

      <input id="adminEmail" type="email" placeholder="Correo del usuario">
      <input id="adminAmount" type="number" placeholder="Cr√©ditos a dar" inputmode="numeric">

      <button id="adminGiveBtn">DAR CR√âDITOS</button>

      <div id="adminMsg" class="small"></div>
    </div>

    <button class="menu-close" id="closeMenuBtn">CERRAR</button>
  </div>
</div>

<!-- MODAL INSTALACI√ìN -->
<div id="installModal">
  <div class="install-card">
    <h3>TIPS DE INSTALACI√ìN</h3>
    <div class="install-sub">‚ö° Solo 3 pasos para instalar la app</div>

    <div id="installSteps" class="install-steps"></div>

    <div class="install-img">
      <img src="install-preview.png">
    </div>

    <div class="install-note" id="installNote"></div>

    <button class="install-btn" onclick="closeInstall()">Necesito Ayuda</button>
  </div>
</div>

<audio id="okAudio" src="ok.mp3" preload="auto"></audio>

<script>
/* =========================
   ‚úÖ EDITA AQU√ç (TUS 2 PERSONAS EXTRA)
   ========================= */

/* Recarga con (modal) ‚Äî agregu√© 2 personas extra al final */
const RECHARGE_CONTACTS = [
  { type:"wa", title:"OWNER", subtitle:"955 912 164", link:"https://wa.me/51955912164", icon:"whatsapp.png" },
  { type:"tg", title:"OWNER", subtitle:"@Dev_MRX00", link:"https://t.me/Dev_MRX00", icon:"telegram.png" },
  { type:"tg", title:"SELLER", subtitle:"@XAM_OFC", link:"https://t.me/XAM_OFC", icon:"telegram.png" },

  /* ‚úÖ Persona extra 1 */
  { type:"tg", title:"SELLER", subtitle:"@Soporte_MRX01", link:"https://t.me/Soporte_MRX01", icon:"telegram.png" },

  /* ‚úÖ Persona extra 2 */
  { type:"tg", title:"SELLER", subtitle:"@Blackops_666", link:"https://t.me/Blackops_666", icon:"telegram.png" },
];

/* Redes sociales (abajo) ‚Äî agregu√© 2 tarjetas extra */
const SOCIAL_CARDS = [
  {
    left:  { type:"tg", label:"OWNER OFICIAL", value:"@Dev_MRX00", link:"https://t.me/Dev_MRX00" },
    right: { type:"wa", label:"OWNER OFICIAL", value:"955 912 164", link:"https://wa.me/51955912164" }
  },
  {
    left:  { type:"tg", label:"SELLER", value:"@XAM_OFC", link:"https://t.me/XAM_OFC" },
    right: { type:"wa", label:"SELLER", value:"927 586 412", link:"https://wa.me/51927586412" }
  },

  /* ‚úÖ Tarjeta extra 1 */
  {
    left:  { type:"tg", label:"SELLER", value:"@MRX_V2", link:"https://t.me/MRX_V2" },
    right: { type:"wa", label:"SELLER", value:"953 064 458", link:"https://wa.me/+51953064458" }
  },

  /* ‚úÖ Tarjeta extra 2 */
  {
    left:  { type:"tg", label:"SELLER", value:"@Blackops_666", link:"https://t.me/Blackops_666" },
    right: { type:"wa", label:"SELLER", value:"901 111 111", link:"https://wa.me/51901111111" }
  }
];

/* =========================
   RENDER LISTS (NO TOCAR)
   ========================= */

function renderRecharge(){
  const box = document.getElementById("rechargeList");
  box.innerHTML = RECHARGE_CONTACTS.map(c => `
    <a class="recharge-link" href="${c.link}" target="_blank" rel="noopener">
      <img src="${c.icon}" alt="">
      <div style="display:flex;flex-direction:column;gap:2px;">
        <b>${c.title}</b>
        <span style="opacity:.85;font-size:12px;">${c.subtitle}</span>
      </div>
      <span class="badge-chip">Abrir</span>
    </a>
  `).join("");
}

function renderSocial(){
  const box = document.getElementById("socialList");
  const iconHtml = (type) => {
    if(type === "wa") return `<div class="icon wa"><img src="whatsapp.png"></div>`;
    return `<div class="icon tg"><img src="telegram.png"></div>`;
  };

  box.innerHTML = SOCIAL_CARDS.map(card => `
    <div class="social-card">
      <div class="contact-block">
        ${iconHtml(card.left.type)}
        <div class="contact-info">
          <div class="role">${card.left.label}</div>
          <div class="handle"><a href="${card.left.link}" target="_blank" rel="noopener">${card.left.value}</a></div>
        </div>
      </div>
      <div class="contact-block">
        ${iconHtml(card.right.type)}
        <div class="contact-info">
          <div class="role">${card.right.label}</div>
          <div class="handle"><a href="${card.right.link}" target="_blank" rel="noopener">${card.right.value}</a></div>
        </div>
      </div>
    </div>
  `).join("");
}

renderRecharge();
renderSocial();

/* ===== SUPABASE ===== */
const { createClient } = window.supabase;

const supabaseClient = createClient(
  "https://ndoblzdqdycipbotwkaq.supabase.co",
  "sb_publishable_61e0-7mYaVwMZ1v44uj77w_xpIdxiFk"
);

/* ===== AUTH GUARD ===== */
(async ()=>{
  const { data:{ session } } = await supabaseClient.auth.getSession();
  if(!session){
    location.replace("login.html");
  } else {
    await loadMyProfile();
    await showToolsByRole();
    await refreshNotifBadge();
  }
})();

/* ===== UI HELPERS ===== */
const modal=document.getElementById("modal");
const modalText=document.getElementById("modalText");
const okBtn=document.getElementById("okBtn");

function showModal(text){
  modalText.textContent = text;
  okBtn.textContent = "OK";
  modal.classList.add("show");
}
okBtn.onclick=()=> modal.classList.remove("show");

/* Recharge modal */
const rechargeModal = document.getElementById("rechargeModal");
document.getElementById("rechargeOk").onclick = () => rechargeModal.classList.remove("show");
function showRecharge(){ rechargeModal.classList.add("show"); }

/* Menu modal */
const menuModal = document.getElementById("menuModal");
document.getElementById("menuBtn").onclick = () => { menuModal.style.display = "flex"; };
document.getElementById("closeMenuBtn").onclick = () => { menuModal.style.display = "none"; };

/* Logout */
document.getElementById("logoutBtn").onclick = async () => {
  await supabaseClient.auth.signOut();
  location.replace("login.html");
};

/* FIX ZOOM iOS */
document.addEventListener('gesturestart', e => e.preventDefault());
document.addEventListener('touchmove', e => {
  if(e.scale !== 1) e.preventDefault();
},{ passive:false });

/* ===== PROFILE: credits/role ===== */
let MY_ROLE = "user";
let MY_CREDITS = 0;

async function loadMyProfile(){
  const { data: { user } } = await supabaseClient.auth.getUser();
  if(!user) return;

  const { data, error } = await supabaseClient
    .from("profiles")
    .select("role, credits")
    .eq("id", user.id)
    .single();

  if(error){
    console.log("Error leyendo profile:", error);
    document.getElementById("roleValue").textContent = "error";
    document.getElementById("creditsValue").textContent = "0";
    return;
  }

  MY_ROLE = (data?.role || "user");
  MY_CREDITS = Number(data?.credits || 0);

  document.getElementById("roleValue").textContent = MY_ROLE;
  document.getElementById("creditsValue").textContent = String(MY_CREDITS);

  // menu info
  document.getElementById("menuRole").textContent = MY_ROLE;
  document.getElementById("menuCredits").textContent = String(MY_CREDITS);
}

/* ===== SHOW TOOLS BY ROLE (IN MENU) ===== */
async function showToolsByRole(){
  if(!MY_ROLE) await loadMyProfile();

  const ownerTools = document.getElementById("ownerTools");
  const adminTools = document.getElementById("adminTools");

  ownerTools.style.display = (MY_ROLE === "owner") ? "block" : "none";
  adminTools.style.display = (MY_ROLE === "admin") ? "block" : "none";
}

/* ===== NOTIFICATIONS BADGE (OWNER) ===== */
async function refreshNotifBadge(){
  if(MY_ROLE !== "owner") return;

  const lastSeen = Number(localStorage.getItem("eventsLastSeenId") || "0");
  const { data, error } = await supabaseClient.rpc("get_recent_events", { p_limit: 50 });

  if(error){
    console.log("No puedo leer eventos:", error);
    return;
  }

  const list = data || [];
  const newCount = list.filter(e => Number(e.id) > lastSeen).length;
  const badge = document.getElementById("notifBadge");

  if(newCount > 0){
    badge.textContent = String(newCount);
    badge.style.display = "inline-block";
  }else{
    badge.style.display = "none";
  }
}

/* ===== PANEL PRINCIPAL (ACCI√ìN) ===== */
const execute=document.getElementById("execute");
const loader=document.getElementById("loader");
const consoleBox=document.getElementById("console");
const numero=document.getElementById("numero");
const pais=document.getElementById("pais");
const okAudio=document.getElementById("okAudio");

let step=0,lastNumber="";

execute.onclick=async ()=>{
  await loadMyProfile();
  if(MY_CREDITS <= 0){
    showRecharge();
    return;
  }

  if(!numero.value.trim()) return;

  lastNumber=pais.value+" "+numero.value.trim();
  loader.style.display="block";
  consoleBox.style.display="block";
  consoleBox.innerHTML="> Iniciando proceso...";

  setTimeout(()=>{
    loader.style.display="none";
    showModal(`¬øQUIERES CONTINUAR?\n\nüì± ${lastNumber}`);
    step=1;
  },1200);
};

document.getElementById("okBtn").onclick=()=>{
  if(step===1){
    modalText.textContent=`‚úÖ OPERACI√ìN COMPLETADA\n\n${lastNumber}`;
    okAudio.play();
    okBtn.textContent="CERRAR";
    step=2;
  }else{
    modal.classList.remove("show");
    location.reload();
  }
};

/* ===== INSTALACI√ìN ===== */
function isInstalled(){
  return window.matchMedia('(display-mode: standalone)').matches
      || window.navigator.standalone === true;
}
function closeInstall(){
  localStorage.setItem("installSeen","1");
  installModal.style.display="none";
}
window.onload=()=>{
  if(isInstalled()) return;
  if(localStorage.getItem("installSeen")) return;

  const ua=navigator.userAgent.toLowerCase();

  if(/iphone|ipad|ipod/.test(ua)){
    installSteps.innerHTML=
    `1. En Safari toca <b>Compartir</b> ‚¨ÜÔ∏è<br>
     2. Selecciona <b>Agregar a inicio</b><br>
     3. Presiona <b>Aceptar</b>`;
    installNote.innerHTML=
    `Nota: iPhone permite instalar la app varias veces. Mant√©n solo una.`;
    installModal.style.display="flex";
  }else if(/android/.test(ua)){
    installSteps.innerHTML=
    `1. Toca los <b>tres puntos</b> ‚ãÆ<br>
     2. <b>Agregar a pantalla principal</b><br>
     3. <b>Instalar</b>`;
    installNote.innerHTML=
    `Si no aparece la opci√≥n, usa Chrome o Brave.`;
    installModal.style.display="flex";
  }
};

if("serviceWorker" in navigator){
  navigator.serviceWorker.register("service-worker.js");
}

/* ===== ADMIN/OWNER ACTIONS (RPC) ===== */
function cleanEmail(v){ return (v || "").trim().toLowerCase(); }
function toInt(v){ return parseInt(String(v || "").trim(), 10); }

/* Admin: dar cr√©ditos */
const adminGiveBtn = document.getElementById("adminGiveBtn");
if(adminGiveBtn){
  adminGiveBtn.onclick = async () => {
    const email = cleanEmail(document.getElementById("adminEmail").value);
    const amount = toInt(document.getElementById("adminAmount").value);
    const msg = document.getElementById("adminMsg");

    msg.textContent = "Procesando...";
    try{
      if(!email) throw new Error("Escribe el correo");
      if(!amount || amount <= 0) throw new Error("Cantidad inv√°lida");

      const { error } = await supabaseClient.rpc("give_credits_by_email", {
        p_email: email,
        p_amount: amount,
        p_note: "venta/admin"
      });
      if(error) throw error;

      msg.textContent = "‚úÖ Cr√©ditos enviados";
      await loadMyProfile();
    }catch(e){
      msg.textContent = "‚ùå " + (e.message || "Error");
    }
  };
}

/* Owner: dar cr√©ditos */
const ownerGiveBtn = document.getElementById("ownerGiveBtn");
if(ownerGiveBtn){
  ownerGiveBtn.onclick = async () => {
    const email = cleanEmail(document.getElementById("ownerEmail").value);
    const amount = toInt(document.getElementById("ownerAmount").value);
    const msg = document.getElementById("ownerMsg");

    msg.textContent = "Procesando...";
    try{
      if(!email) throw new Error("Escribe el correo");
      if(!amount || amount <= 0) throw new Error("Cantidad inv√°lida");

      const { error } = await supabaseClient.rpc("give_credits_by_email", {
        p_email: email,
        p_amount: amount,
        p_note: "venta/owner"
      });
      if(error) throw error;

      msg.textContent = "‚úÖ Cr√©ditos enviados";
      await refreshNotifBadge();
      await loadMyProfile();
    }catch(e){
      msg.textContent = "‚ùå " + (e.message || "Error");
    }
  };
}

/* Owner: quitar cr√©ditos */
const ownerRemoveBtn = document.getElementById("ownerRemoveBtn");
if(ownerRemoveBtn){
  ownerRemoveBtn.onclick = async () => {
    const email = cleanEmail(document.getElementById("ownerEmail").value);
    const amount = toInt(document.getElementById("ownerAmount").value);
    const msg = document.getElementById("ownerMsg");

    msg.textContent = "Procesando...";
    try{
      if(!email) throw new Error("Escribe el correo");
      if(!amount || amount <= 0) throw new Error("Cantidad inv√°lida");

      const { error } = await supabaseClient.rpc("remove_credits_by_email", {
        p_email: email,
        p_amount: amount,
        p_note: "ajuste/owner"
      });
      if(error) throw error;

      msg.textContent = "‚úÖ Cr√©ditos quitados";
      await refreshNotifBadge();
      await loadMyProfile();
    }catch(e){
      msg.textContent = "‚ùå " + (e.message || "Error");
    }
  };
}

/* Owner: dar/quitar admin */
const makeAdminBtn = document.getElementById("makeAdminBtn");
if(makeAdminBtn){
  makeAdminBtn.onclick = async () => {
    const email = cleanEmail(document.getElementById("ownerEmail").value);
    const msg = document.getElementById("ownerMsg");

    msg.textContent = "Procesando...";
    try{
      if(!email) throw new Error("Escribe el correo");

      const { error } = await supabaseClient.rpc("set_admin_by_email", {
        p_email: email,
        p_make_admin: true
      });
      if(error) throw error;

      msg.textContent = "‚úÖ Ahora es ADMIN";
      await refreshNotifBadge();
    }catch(e){
      msg.textContent = "‚ùå " + (e.message || "Error");
    }
  };
}

const removeAdminBtn = document.getElementById("removeAdminBtn");
if(removeAdminBtn){
  removeAdminBtn.onclick = async () => {
    const email = cleanEmail(document.getElementById("ownerEmail").value);
    const msg = document.getElementById("ownerMsg");

    msg.textContent = "Procesando...";
    try{
      if(!email) throw new Error("Escribe el correo");

      const { error } = await supabaseClient.rpc("set_admin_by_email", {
        p_email: email,
        p_make_admin: false
      });
      if(error) throw error;

      msg.textContent = "‚úÖ Admin quitado (vuelve a USER)";
      await refreshNotifBadge();
    }catch(e){
      msg.textContent = "‚ùå " + (e.message || "Error");
    }
  };
}

/* Owner: ver notificaciones */
const loadEventsBtn = document.getElementById("loadEventsBtn");
if(loadEventsBtn){
  loadEventsBtn.onclick = async () => {
    const box = document.getElementById("eventsBox");
    box.textContent = "Cargando...";

    const { data, error } = await supabaseClient.rpc("get_recent_events", { p_limit: 30 });
    if(error){
      box.textContent = "‚ùå " + (error.message || "Error");
      return;
    }

    const list = data || [];
    if(list.length === 0){
      box.textContent = "Sin notificaciones a√∫n.";
      return;
    }

    localStorage.setItem("eventsLastSeenId", String(list[0].id));
    await refreshNotifBadge();

    const mapType = (t) => {
      if(t === "CREDIT_ADD") return "‚ûï Cr√©ditos";
      if(t === "CREDIT_REMOVE") return "‚ûñ Cr√©ditos";
      if(t === "MAKE_ADMIN") return "üëë Dar admin";
      if(t === "REMOVE_ADMIN") return "‚ùå Quitar admin";
      return t;
    };

    box.textContent = list.map(e => {
      const when = new Date(e.created_at).toLocaleString();
      const amt = (e.amount == null) ? "" : ` (${e.amount})`;
      const actor = e.actor_email ? ` | ${e.actor_email}` : "";
      return `${mapType(e.event_type)}${amt} ‚Üí ${e.target_email || ""}${actor}\n${when}\n`;
    }).join("\n");
  };
}
</script>

</body>
</html>
