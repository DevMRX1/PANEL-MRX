<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">

<!-- VIEWPORT -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

<!-- iOS PWA -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="PANEL MRX">

<title>PANEL MRX</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<link rel="apple-touch-icon" href="apple-touch-icon.png">

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* âœ… iOS: permitir fill-available */
html{
  height: -webkit-fill-available;
}

/* FIX IOS + ANDROID */
html, body {
  height: 100%;
  overscroll-behavior: none;
}

/* =====================
   TU CSS ORIGINAL
   ===================== */

*{box-sizing:border-box}

body{
  margin:0;
  font-family:Inter,system-ui;
  color:#fff;
  display:flex;
  justify-content:center;
  align-items:center;

  /* âœ… altura real en mÃ³viles */
  min-height: 100dvh;
  min-height: -webkit-fill-available;

  background:#000;
  overflow:hidden;

  /* âœ… Safe Area iPhone (sin romper el centrado) */
  padding-top: env(safe-area-inset-top);
  padding-bottom: env(safe-area-inset-bottom);
  padding-left: env(safe-area-inset-left);
  padding-right: env(safe-area-inset-right);
}

#bgImage{
  position:fixed; inset:0;
  width:100%; height:100%;
  object-fit:cover;
  filter:blur(10px);
  opacity:.55;
  z-index:-1;
}
.panel{
  width:90%; max-width:360px;
  padding:26px 22px;
  border-radius:28px;
  background:rgba(0,0,0,.22);
  backdrop-filter:blur(18px);
  border:1px solid rgba(255,255,255,.12);
  position:relative;
  box-shadow:0 0 60px rgba(0,224,255,.08);
}
h1{text-align:center;margin:0;letter-spacing:1px}
.subtitle{text-align:center;font-size:12px;opacity:.7;margin-bottom:18px}
.avatar{display:flex;justify-content:center;margin-bottom:18px}
.avatar img{
  width:96px;height:96px;border-radius:50%;
  border:2px solid #00e0ff;
  box-shadow:0 0 25px #00e0ff
}
label{font-size:12px;opacity:.8}
select,input{
  width:80%;
  padding:12px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.1);
  background:rgba(0,0,0,.3);
  color:#fff;
  margin:6px auto 14px;
  display:block;
  font-size:16px;
}
button{
  width:90%;
  padding:14px;
  border-radius:22px;
  border:none;
  background:linear-gradient(135deg,#00e0ff,#7b3fe4);
  color:#fff;
  font-weight:600;
  cursor:pointer;
}
button:active{transform:scale(.97)}
.loader{
  display:none;margin:14px auto;
  width:28px;height:28px;border-radius:50%;
  border:4px solid rgba(255,255,255,.2);
  border-top-color:#00e0ff;
  animation:spin 1s linear infinite
}
@keyframes spin{to{transform:rotate(360deg)}}
.console{
  display:none;margin:14px auto 0;width:90%;
  max-height:140px;overflow:auto;
  background:rgba(0,0,0,.3);
  border-radius:14px;padding:10px;
  font-family:monospace;font-size:12px;color:#0ff
}

/* MODAL PRINCIPAL */
.modal{
  position:fixed;inset:0;
  background:rgba(0,0,0,.45);
  display:flex;justify-content:center;align-items:center;
  opacity:0;pointer-events:none;transition:.2s;
  z-index:9998;
}
.modal.show{opacity:1;pointer-events:auto}
.modal-box{
  width:90%;max-width:320px;
  background:rgba(0,0,0,.28);
  backdrop-filter:blur(16px);
  border-radius:22px;padding:22px;text-align:center;
  border:1px solid rgba(255,255,255,.12);
  box-shadow:0 0 40px rgba(0,224,255,.08);
}
.modal-box p{white-space:pre-line;font-size:14px}

/* REDES */
.footer{margin-top:26px}
.footer b{font-size:12px}
.social{
  margin-top:16px;
  display:flex;
  flex-direction:column;
  gap:18px;

  /* âœ… scroll cuando agregues mÃ¡s */
  max-height:220px;
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
  padding-right:6px;
}
.social::-webkit-scrollbar{width:6px;}
.social::-webkit-scrollbar-thumb{background:rgba(255,255,255,.18);border-radius:10px;}

.social-card{
  display:flex;justify-content:space-between;align-items:center;
  padding:18px 16px;border-radius:24px;
  background:rgba(0,0,0,.28);
  border:1px solid rgba(255,255,255,.10);
}
.contact-block{display:flex;align-items:center;gap:14px}
.icon{
  width:40px;height:40px;border-radius:50%;
  display:flex;justify-content:center;align-items:center
}
.icon img{width:22px}
.icon.tg{background:#0088cc}
.icon.wa{background:#25D366}
.contact-info{font-size:12px;line-height:1.25}
.role{font-size:10px;opacity:.6}
.handle a{color:#fff;text-decoration:none;font-weight:600}

/* ===== TOP BAR BUTTONS ===== */
.top-left, .top-right{
  position:absolute;
  top:14px;
  z-index:5;
}
.top-left{ left:14px; }
.top-right{ right:14px; }

.icon-btn{
  width:44px;height:44px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.28);
  backdrop-filter:blur(14px);
  color:#fff;
  display:flex;
  justify-content:center;
  align-items:center;
  cursor:pointer;
  user-select:none;
}
.icon-btn:active{ transform:scale(.97); }

/* ===== MENU MODAL (HAMBURGER) ===== */
#menuModal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  justify-content:center;
  align-items:flex-start;
  padding-top:80px;
  z-index:9997;
}
.menu-card{
  width:92%;
  max-width:360px;
  border-radius:22px;
  padding:18px;
  background:rgba(0,0,0,.35);
  backdrop-filter:blur(18px);
  border:1px solid rgba(255,255,255,.12);
  box-shadow:0 0 50px rgba(123,63,228,.12);
}
.menu-title{
  font-weight:900;
  text-align:center;
  margin-bottom:10px;
  letter-spacing:1px;
}
.menu-close{
  margin-top:12px;
  width:100%;
  background:#333;
}
.hr{
  height:1px;
  background:rgba(255,255,255,.12);
  margin:12px 0;
}

/* Tools blocks inside menu */
.tools{ display:none; }

/* âœ… inputs mÃ¡s cortos en admin/owner */
.tools input{
  width:100%;
  max-width:300px;
  margin:6px auto 12px;
  display:block;
}

.tools button{ width:100%; }

.small{
  font-size:12px;
  opacity:.85;
  text-align:center;
  margin-top:10px;
}

/* ===== RECHARGE MODAL ===== */
#rechargeModal .modal-box{
  text-align:left;
}
.recharge-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:8px;
}
.recharge-title{
  font-weight:900;
  font-size:16px;
}
.recharge-sub{ opacity:.85; margin-top:6px; }

/* âœ… scroll cuando agregues mÃ¡s */
.recharge-links{
  margin-top:12px;
  display:flex;
  flex-direction:column;
  gap:10px;

  max-height:280px;
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
  padding-right:6px;
}
.recharge-links::-webkit-scrollbar{width:6px;}
.recharge-links::-webkit-scrollbar-thumb{
  background:rgba(255,255,255,.18);
  border-radius:10px;
}

.recharge-link{
  display:flex;
  align-items:center;
  gap:10px;
  padding:12px 12px;
  border-radius:16px;
  background:rgba(0,0,0,.35);
  border:1px solid rgba(255,255,255,.12);
  text-decoration:none;
  color:#fff;
}
.recharge-link img{ width:18px; height:18px; }
.recharge-link:active{ transform:scale(.99); }

/* chips cyber */
.badge-chip{
  margin-left:auto;
  opacity:.7;
  font-size:12px;
}

/* ===== mini glow lines ===== */
.glowline{
  height:1px;
  background:linear-gradient(90deg,transparent,rgba(0,224,255,.35),transparent);
  margin:10px 0;
}
</style>
</head>

<body>

<img src="fondo.jpg" id="bgImage">

<div class="panel">

  <!-- TOP LEFT: LOGOUT -->
  <div class="top-left">
    <div class="icon-btn" id="logoutBtn" title="Cerrar sesiÃ³n">â‹</div>
  </div>

  <!-- TOP RIGHT: HAMBURGER -->
  <div class="top-right">
    <div class="icon-btn" id="menuBtn" title="MenÃº">â‰¡</div>
  </div>

  <h1>ğğ€ğğ„ğ‹ ğŒğ‘ğ—</h1>

  <!-- CrÃ©ditos arriba -->
  <div id="creditsBox" style="margin-top:6px;text-align:center;font-size:13px;opacity:.85;">
    ğŸ’³ ğ™²ğš›ğšğšğš’ğšğš˜ğšœ: <b id="creditsValue">0</b>
  </div>

  <div id="roleStatus" style="margin-top:4px;text-align:center;font-size:12px;opacity:.8;">
    ğŸ‘¤ ğšğš˜ğš•: <b id="roleValue">ğ•®ğ–†ğ–—ğ–Œğ–†ğ–“ğ–‰ğ–”â€¦</b>
  </div>



<!-- PUSH BANNER (para todos) -->
<div id="pushBanner" style="display:none;margin-top:10px;text-align:center;">
  <div style="font-size:12px;opacity:.9;margin-bottom:8px;">
    ğŸ”” Activa notificaciones para recibir avisos de crÃ©ditos
  </div>
  <button id="pushEnableBtn" style="width:90%;background:linear-gradient(135deg,#ffaa00,#ff5f00);">
    Activar notificaciones
  </button>
</div>


  <div class="glowline"></div>

  <!-- (Texto neutral) -->
  <div class="subtitle">ğğ€ğ ğ–ğ‡ğ€ğ“ğ’ğ€ğğ</div>

  <div class="avatar"><img src="avatar.jpg"></div>

  <label>ğ™‹ğ˜¼ğ™„ğ™</label>
  <select id="pais">
    <option value="+51" selected>ğŸ‡µğŸ‡ª PerÃº</option>
    <option value="+1">ğŸ‡ºğŸ‡¸ USA</option>
    <option value="+52">ğŸ‡²ğŸ‡½ MÃ©xico</option>
    <option value="+54">ğŸ‡¦ğŸ‡· Argentina</option>
    <option value="+55">ğŸ‡§ğŸ‡· Brasil</option>
    <option value="+56">ğŸ‡¨ğŸ‡± Chile</option>
    <option value="+57">ğŸ‡¨ğŸ‡´ Colombia</option>
    <option value="+34">ğŸ‡ªğŸ‡¸ EspaÃ±a</option>
    <option value="+44">ğŸ‡¬ğŸ‡§ Reino Unido</option>
    <option value="+49">ğŸ‡©ğŸ‡ª Alemania</option>
    <option value="+33">ğŸ‡«ğŸ‡· Francia</option>
  </select>

  <label>ğ™‰ğ™ğ™ˆğ™€ğ™ğ™Š</label>
  <input type="tel" id="numero" placeholder="Ingresa el nÃºmero" inputmode="numeric">

  <button id="execute">ï¼¢ï¼¡ï¼®ï¼¥ï¼¡ï¼²</button>

  <div class="loader" id="loader"></div>
  <div class="console" id="console"></div>

  <div class="footer">
    <b>ğŸ“² ğšğ™´ğ™³ğ™´ğš‚ ğš‚ğ™¾ğ™²ğ™¸ğ™°ğ™»ğ™´ğš‚</b>
    <div class="social" id="socialList"></div>
  </div>
</div>

<!-- MODAL PRINCIPAL -->
<div class="modal" id="modal">
  <div class="modal-box">
    <p id="modalText"></p>
    <button id="okBtn">ï¼¯ï¼«</button>
  </div>
</div>

<!-- MODAL RECARGA (SIN CRÃ‰DITOS) -->
<div class="modal" id="rechargeModal">
  <div class="modal-box" style="position:relative;">
    <div class="recharge-head">
      <div class="recharge-title">ğ˜•ğ˜° ğ˜µğ˜ªğ˜¦ğ˜¯ğ˜¦ğ˜´ ğ˜´ğ˜¶ğ˜§ğ˜ªğ˜¤ğ˜ªğ˜¦ğ˜¯ğ˜µğ˜¦ğ˜´ ğ˜¤ğ˜³ğ˜¦ğ˜¥ğ˜ªğ˜µğ˜°ğ˜´</div>
    </div>

    <div class="recharge-sub">ğ—¥ğ—²ğ—°ğ—®ğ—¿ğ—´ğ—® ğ—°ğ—¼ğ—»:</div>

    <div class="recharge-links" id="rechargeList"></div>

    <button id="rechargeOk" style="margin-top:14px;width:100%;">ğ‚ğ„ğ‘ğ‘ğ€ğ‘</button>
  </div>
</div>

<!-- MODAL MENÃš (â˜°) -->
<div id="menuModal">
  <div class="menu-card">
    <div class="menu-title">MENÃš</div>

    <div style="text-align:center;font-size:12px;opacity:.85;">
      ğŸ’³ <b id="menuCredits">0</b> ğ™²ğš›ğšğšğš’ğšğš˜ğšœ â€¢ ğŸ‘¤ <b id="menuRole">user</b>
    </div>

    <div class="hr"></div>

    <!-- OWNER TOOLS -->
    <div class="tools" id="ownerTools">
      <div style="text-align:center;font-weight:900;margin-bottom:10px;">
        ğŸ‘‘ á´˜á´€É´á´‡ÊŸ á´á´¡É´á´‡Ê€
        <span id="notifBadge" style="display:none;margin-left:8px;padding:2px 8px;border-radius:999px;background:#00e0ff;color:#000;font-size:12px;">0</span>
      </div>

      <input id="ownerEmail" type="email" placeholder="Correo del usuario">
      <input id="ownerAmount" type="number" placeholder="CrÃ©ditos (nÃºmero)" inputmode="numeric">

      <button id="ownerGiveBtn">á´…á´€Ê€ á´„Ê€á´‡á´…Éªá´›á´s</button>

      <button id="ownerRemoveBtn" style="margin-top:8px;background:linear-gradient(135deg,#ff3b3b,#7b3fe4);">
        Ç«á´œÉªá´›á´€Ê€ á´„Ê€á´‡á´…Éªá´›á´s
      </button>

      <button id="makeAdminBtn" style="margin-top:12px;background:linear-gradient(135deg,#00e0ff,#21c7b7);">
        á´…á´€Ê€ á´€á´…á´ÉªÉ´
      </button>

      <button id="removeAdminBtn" style="margin-top:8px;background:linear-gradient(135deg,#ffb000,#7b3fe4);">
        Ç«á´œÉªá´›á´€Ê€ á´€á´…á´ÉªÉ´
      </button>

      <button id="loadEventsBtn" style="margin-top:12px;background:#333;">
        á´ á´‡Ê€ É´á´á´›Éªêœ°Éªá´„á´€á´„Éªá´É´á´‡s
      </button>

      <div id="eventsBox" style="margin-top:10px;font-family:monospace;font-size:12px;white-space:pre-line;max-height:160px;overflow:auto;"></div>



<button id="enablePushBtn" style="margin-top:12px;background:linear-gradient(135deg,#ffaa00,#ff5f00);">
  ğŸ”” Activar notificaciones
</button>
 
      <div id="ownerMsg" class="small"></div>
    </div>

    <!-- ADMIN TOOLS -->
    <div class="tools" id="adminTools">
      <div style="text-align:center;font-weight:900;margin-bottom:10px;">ğŸ› ï¸ á´˜á´€É´á´‡ÊŸ á´€á´…á´ÉªÉ´</div>

      <input id="adminEmail" type="email" placeholder="Correo del usuario">
      <input id="adminAmount" type="number" placeholder="CrÃ©ditos a dar" inputmode="numeric">

      <button id="adminGiveBtn">á´…á´€Ê€ á´„Ê€á´‡á´…Éªá´›á´s</button>

      <div id="adminMsg" class="small"></div>
    </div>

    <button class="menu-close" id="closeMenuBtn">á´„á´‡Ê€Ê€á´€Ê€</button>
  </div>
</div>

<audio id="okAudio" src="ok.mp3" preload="auto"></audio>

<script>
/* =========================
   LISTAS
   ========================= */
const RECHARGE_CONTACTS = [
  { type:"wa", title:"OWNER", subtitle:"955 912 164", link:"https://wa.me/51955912164", icon:"whatsapp.png" },
  { type:"tg", title:"OWNER", subtitle:"@Dev_MRX00", link:"https://t.me/Dev_MRX00", icon:"telegram.png" }
];

const SOCIAL_CARDS = [
  {
    left:  { type:"tg", label:"TELEGRAM", value:"@Dev_MRX00", link:"https://t.me/Dev_MRX00" },
    right: { type:"wa", label:"WHATSAPP", value:"955 912 164", link:"https://wa.me/51955912164" }
  }
];

function renderRecharge(){
  const box = document.getElementById("rechargeList");
  box.innerHTML = RECHARGE_CONTACTS.map(c => `
    <a class="recharge-link" href="${c.link}" target="_blank" rel="noopener">
      <img src="${c.icon}" alt="">
      <div style="display:flex;flex-direction:column;gap:2px;">
        <b>${c.title}</b>
        <span style="opacity:.85;font-size:12px;">${c.subtitle}</span>
      </div>
      <span class="badge-chip">Abrir</span>
    </a>
  `).join("");
}

function renderSocial(){
  const box = document.getElementById("socialList");
  const iconHtml = (type) => {
    if(type === "wa") return `<div class="icon wa"><img src="whatsapp.png"></div>`;
    return `<div class="icon tg"><img src="telegram.png"></div>`;
  };

  box.innerHTML = SOCIAL_CARDS.map(card => `
    <div class="social-card">
      <div class="contact-block">
        ${iconHtml(card.left.type)}
        <div class="contact-info">
          <div class="role">${card.left.label}</div>
          <div class="handle"><a href="${card.left.link}" target="_blank" rel="noopener">${card.left.value}</a></div>
        </div>
      </div>
      <div class="contact-block">
        ${iconHtml(card.right.type)}
        <div class="contact-info">
          <div class="role">${card.right.label}</div>
          <div class="handle"><a href="${card.right.link}" target="_blank" rel="noopener">${card.right.value}</a></div>
        </div>
      </div>
    </div>
  `).join("");
}

renderRecharge();
renderSocial();

/* ===== SUPABASE ===== */
const { createClient } = window.supabase;

const supabaseClient = createClient(
  "https://ndoblzdqdycipbotwkaq.supabase.co",
  "sb_publishable_61e0-7mYaVwMZ1v44uj77w_xpIdxiFk"
);

/* ===== AUTH GUARD ===== */
(async ()=>{
  const { data:{ session } } = await supabaseClient.auth.getSession();
  if(!session){
    location.replace("login.html");
  } else {
    await loadMyProfile();
    await showToolsByRole();
    await refreshNotifBadge();
    await startOwnerRealtimeNotif(); // âœ… IMPORTANTE
	 await maybeShowPushBanner();
  }
})();




/* ===== MODAL HELPERS ===== */
const modal = document.getElementById("modal");
const modalText = document.getElementById("modalText");
const okBtn = document.getElementById("okBtn");

function showModal(text){
  modalText.textContent = text;
  okBtn.textContent = "OK";
  modal.classList.add("show");
}
function closeModal(){
  modal.classList.remove("show");
}


// âœ… MODAL NEUTRAL (no usa step, no toca el flujo de crÃ©ditos)
function showPushModal(text){
  modalText.textContent = text;
  okBtn.disabled = false;
  okBtn.textContent = "CERRAR";
  modal.classList.add("show");

  // importante: este onclick SOLO cierra (no consume crÃ©ditos, no recarga)
  okBtn.onclick = () => {
    modal.classList.remove("show");
  };
}




/* Recharge modal */
const rechargeModal = document.getElementById("rechargeModal");
document.getElementById("rechargeOk").onclick = () => rechargeModal.classList.remove("show");
function showRecharge(){ rechargeModal.classList.add("show"); }

/* Menu modal */
const menuModal = document.getElementById("menuModal");
document.getElementById("menuBtn").onclick = () => { menuModal.style.display = "flex"; };
document.getElementById("closeMenuBtn").onclick = () => { menuModal.style.display = "none"; };

/* Logout */
document.getElementById("logoutBtn").onclick = async () => {
  try {
    if (creditChannel) await supabaseClient.removeChannel(creditChannel);
  } catch (e) {}

  await supabaseClient.auth.signOut();
  location.replace("login.html");
};

/* FIX ZOOM iOS */
document.addEventListener('gesturestart', e => e.preventDefault());
document.addEventListener('touchmove', e => {
  if(e.scale !== 1) e.preventDefault();
},{ passive:false });

/* ===== PROFILE: credits/role ===== */
let MY_ROLE = "user";
let MY_CREDITS = 0;

async function loadMyProfile(){
  const { data: { user } } = await supabaseClient.auth.getUser();
  if(!user) return;

  const { data, error } = await supabaseClient
    .from("profiles")
    .select("role, credits")
    .eq("id", user.id)
    .single();

  if(error){
    console.log("Error leyendo profile:", error);
    document.getElementById("roleValue").textContent = "error";
    document.getElementById("creditsValue").textContent = "0";
    return;
  }

  MY_ROLE = (data?.role || "user");
  MY_CREDITS = Number(data?.credits || 0);

  document.getElementById("roleValue").textContent = MY_ROLE;
  document.getElementById("creditsValue").textContent = String(MY_CREDITS);

  // menu info
  document.getElementById("menuRole").textContent = MY_ROLE;
  document.getElementById("menuCredits").textContent = String(MY_CREDITS);
}

/* ===== SHOW TOOLS BY ROLE (IN MENU) ===== */
async function showToolsByRole(){
  if(!MY_ROLE) await loadMyProfile();

  const ownerTools = document.getElementById("ownerTools");
  const adminTools = document.getElementById("adminTools");

  ownerTools.style.display = (MY_ROLE === "owner") ? "block" : "none";
  adminTools.style.display = (MY_ROLE === "admin") ? "block" : "none";
}



async function enablePush(){
  if(!("serviceWorker" in navigator)) return;

  const perm = await Notification.requestPermission();
  if(perm !== "granted"){
    alert("Debes permitir notificaciones");
    return;
  }

  const reg = await navigator.serviceWorker.ready;

  const vapidKey = "BIN1OWdYIaLHsghdp42zZBTXwLjHMGfJrd7GjsUpWiO6ujGLHB8M2Vq5QpbqKMQTIGf17BXRCvX7jP4h9JU67AU";

  const sub = await reg.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: vapidKey
  });

  const json = sub.toJSON();

  await supabaseClient.from("push_subscriptions").upsert({
    user_id: (await supabaseClient.auth.getUser()).data.user.id,
    endpoint: json.endpoint,
    p256dh: json.keys.p256dh,
    auth: json.keys.auth
  });

  alert("Notificaciones activadas âœ…");
}




// =====================
// REALTIME NOTIF (OWNER)
// =====================
let creditChannel = null;

async function startOwnerRealtimeNotif(){
  // solo owner
  if (MY_ROLE !== "owner") return;

  const { data: { user }, error } = await supabaseClient.auth.getUser();
  if (error || !user) return;

  const OWNER_ID = user.id;

  // evita duplicados si recargas perfil o entras varias veces
  if (creditChannel) {
    await supabaseClient.removeChannel(creditChannel);
    creditChannel = null;
  }

  creditChannel = supabaseClient
    .channel("owner-credit-events")
    .on(
      "postgres_changes",
      {
        event: "INSERT",
        schema: "public",
        table: "credit_events",
        filter: `target_user_id=eq.${OWNER_ID}`
      },
      (payload) => {
        const e = payload.new || {};
        const actor = e.actor_email || "alguien";
        const amt = (e.amount ?? 0);

        // ğŸ”” aviso dentro del panel
        showModal(`â• CrÃ©ditos recibidos\n\nğŸ‘¤ ${actor}\nğŸ’³ +${amt}\nğŸ“© ${e.target_email || ""}`);

        // refrescar badge
        refreshNotifBadge();
      }
    )
    .subscribe();
}

/* ===== NOTIFICATIONS BADGE (OWNER) ===== */
async function refreshNotifBadge(){
  if(MY_ROLE !== "owner") return;

  const lastSeen = Number(localStorage.getItem("eventsLastSeenId") || "0");
  const { data, error } = await supabaseClient.rpc("get_recent_events", { p_limit: 50 });

  if(error){
    console.log("No puedo leer eventos:", error);
    return;
  }

  const list = data || [];
  const newCount = list.filter(e => Number(e.id) > lastSeen).length;
  const badge = document.getElementById("notifBadge");

  if(newCount > 0){
    badge.textContent = String(newCount);
    badge.style.display = "inline-block";
  }else{
    badge.style.display = "none";
  }
}

/* ===== PANEL PRINCIPAL (ACCIÃ“N) ===== */
const execute = document.getElementById("execute");
const loader = document.getElementById("loader");
const consoleBox = document.getElementById("console");
const numero = document.getElementById("numero");
const pais = document.getElementById("pais");
const okAudio = document.getElementById("okAudio");

/* âœ… Anti doble tap + control de pasos */
let isProcessing = false;
let step = 0;
let lastNumber = "";

/* âœ… 1) EJECUTAR: SOLO CONFIRMA (NO COBRA) */
execute.onclick = async () => {
  if (isProcessing) return;
  isProcessing = true;

  try {
    await loadMyProfile();

    if (MY_CREDITS < 10) {
      showRecharge();
      return;
    }

    if (!numero.value.trim()) return;

    lastNumber = pais.value + " " + numero.value.trim();

    step = 10;
    showModal(`Â¿Ç«á´œÉªá´‡Ê€á´‡s á´…á´€Ê€ÊŸá´‡ á´…á´‡ Ê™á´€á´Šá´€ á´€ á´‡sá´›á´‡ Ê™á´€Ê™á´sá´?\n\nğŸ“± ${lastNumber}`); // NO cobra aquÃ­

  } finally {
    isProcessing = false;
  }
};

/* âœ… 2) OK: SI step=10 -> COBRA 10 VEZ Y MUESTRA COMPLETADO
      SI step=2 -> CIERRA Y RECARGA */
okBtn.onclick = async () => {

  // ConfirmaciÃ³n -> cobrar
  if (step === 10) {
    if (isProcessing) return;
    isProcessing = true;

    okBtn.disabled = true;
    okBtn.textContent = "Procesando...";

    loader.style.display = "block";
    consoleBox.style.display = "block";
    consoleBox.innerHTML = "> Procesando...";

    try {
      const { data: newCredits, error } = await supabaseClient.rpc("consume_credit");
      if (error) throw error;

      // Sync UI con lo real de Supabase
      MY_CREDITS = Number(newCredits || 0);
      document.getElementById("creditsValue").textContent = String(MY_CREDITS);
      document.getElementById("menuCredits").textContent = String(MY_CREDITS);

      loader.style.display = "none";
      consoleBox.innerHTML = `> OPERACION COMPLETADA âœ…\n`;

      okAudio.play();

      // Cambia modal a completado
      step = 2;
      modalText.textContent = `âœ… á´á´˜á´‡Ê€á´€á´„Éªá´É´ á´„á´á´á´˜ÊŸá´‡á´›á´€á´…á´€\n\nğŸ“± ${lastNumber}\n\nğŸ’³ á´„Ê€á´‡á´…Éªá´›á´s: ${MY_CREDITS}`;
      okBtn.textContent = "CERRAR";

    } catch (e) {
      loader.style.display = "none";
      consoleBox.innerHTML = `> âŒ Error: ${e.message || "No se pudo descontar"}`;

      // se queda en paso 1 para reintentar
      step = 10;
      modalText.textContent = `âŒ No se pudo descontar crÃ©dito\n\n${e.message || ""}`;
      okBtn.textContent = "OK";

    } finally {
      okBtn.disabled = false;
      okBtn.textContent = (step === 2) ? "CERRAR" : "OK";
      isProcessing = false;
    }

    return;
  }

  // Cerrar -> recarga (y el input queda vacÃ­o)
  if (step === 2) {
    modal.classList.remove("show");
    step = 0;
    location.reload();
    return;
  }

  // fallback
  modal.classList.remove("show");
  step = 0;
};

// ===== SERVICE WORKER (REGISTRO FUERTE + DEBUG) =====
let SW_REG = null;

async function initServiceWorker(){
  try{
    if(!("serviceWorker" in navigator)) {
      console.log("No SW");
      return null;
    }

    // registra con scope raÃ­z
    const reg = await navigator.serviceWorker.register("/service-worker.js", { scope: "/" });

    // iOS a veces necesita un update
    try { await reg.update(); } catch(e){}

    // espera a que estÃ© listo
    SW_REG = await navigator.serviceWorker.ready;

    return SW_REG;
  }catch(e){
    console.log("SW init error:", e);
    return null;
  }
}

// inicializa apenas carga
initServiceWorker();

/* ===== ADMIN/OWNER ACTIONS (RPC) ===== */
function cleanEmail(v){ return (v || "").trim().toLowerCase(); }
function toInt(v){ return parseInt(String(v || "").trim(), 10); }

/* Admin: dar crÃ©ditos */
const adminGiveBtn = document.getElementById("adminGiveBtn");
if(adminGiveBtn){
  adminGiveBtn.onclick = async () => {
    const email = cleanEmail(document.getElementById("adminEmail").value);
    const amount = toInt(document.getElementById("adminAmount").value);
    const msg = document.getElementById("adminMsg");

    msg.textContent = "Procesando...";
    try{
      if(!email) throw new Error("Escribe el correo");
      if(!amount || amount <= 0) throw new Error("Cantidad invÃ¡lida");

      const { error } = await supabaseClient.rpc("give_credits_by_email", {
        p_email: email,
        p_amount: amount,
        p_note: "venta/admin"
      });
      if(error) throw error;

      msg.textContent = "âœ… CrÃ©ditos enviados";
      await loadMyProfile();
    }catch(e){
      msg.textContent = "âŒ " + (e.message || "Error");
    }
  };
}

/* Owner: dar crÃ©ditos */
const ownerGiveBtn = document.getElementById("ownerGiveBtn");
if(ownerGiveBtn){
  ownerGiveBtn.onclick = async () => {
    const email = cleanEmail(document.getElementById("ownerEmail").value);
    const amount = toInt(document.getElementById("ownerAmount").value);
    const msg = document.getElementById("ownerMsg");

    msg.textContent = "Procesando...";
    try{
      if(!email) throw new Error("Escribe el correo");
      if(!amount || amount <= 0) throw new Error("Cantidad invÃ¡lida");

      const { error } = await supabaseClient.rpc("give_credits_by_email", {
        p_email: email,
        p_amount: amount,
        p_note: "venta/owner"
      });
      if(error) throw error;

      msg.textContent = "âœ… CrÃ©ditos enviados";
      await refreshNotifBadge();
      await loadMyProfile();
    }catch(e){
      msg.textContent = "âŒ " + (e.message || "Error");
    }
  };
}

/* Owner: quitar crÃ©ditos */
const ownerRemoveBtn = document.getElementById("ownerRemoveBtn");
if(ownerRemoveBtn){
  ownerRemoveBtn.onclick = async () => {
    const email = cleanEmail(document.getElementById("ownerEmail").value);
    const amount = toInt(document.getElementById("ownerAmount").value);
    const msg = document.getElementById("ownerMsg");

    msg.textContent = "Procesando...";
    try{
      if(!email) throw new Error("Escribe el correo");
      if(!amount || amount <= 0) throw new Error("Cantidad invÃ¡lida");

      const { error } = await supabaseClient.rpc("remove_credits_by_email", {
        p_email: email,
        p_amount: amount,
        p_note: "ajuste/owner"
      });
      if(error) throw error;

      msg.textContent = "âœ… CrÃ©ditos quitados";
      await refreshNotifBadge();
      await loadMyProfile();
    }catch(e){
      msg.textContent = "âŒ " + (e.message || "Error");
    }
  };
}

/* Owner: dar/quitar admin */
const makeAdminBtn = document.getElementById("makeAdminBtn");
if(makeAdminBtn){
  makeAdminBtn.onclick = async () => {
    const email = cleanEmail(document.getElementById("ownerEmail").value);
    const msg = document.getElementById("ownerMsg");

    msg.textContent = "Procesando...";
    try{
      if(!email) throw new Error("Escribe el correo");

      const { error } = await supabaseClient.rpc("set_admin_by_email", {
        p_email: email,
        p_make_admin: true
      });
      if(error) throw error;

      msg.textContent = "âœ… Ahora es ADMIN";
      await refreshNotifBadge();
    }catch(e){
      msg.textContent = "âŒ " + (e.message || "Error");
    }
  };
}

const removeAdminBtn = document.getElementById("removeAdminBtn");
if(removeAdminBtn){
  removeAdminBtn.onclick = async () => {
    const email = cleanEmail(document.getElementById("ownerEmail").value);
    const msg = document.getElementById("ownerMsg");

    msg.textContent = "Procesando...";
    try{
      if(!email) throw new Error("Escribe el correo");

      const { error } = await supabaseClient.rpc("set_admin_by_email", {
        p_email: email,
        p_make_admin: false
      });
      if(error) throw error;

      msg.textContent = "âœ… Admin quitado (vuelve a USER)";
      await refreshNotifBadge();
    }catch(e){
      msg.textContent = "âŒ " + (e.message || "Error");
    }
  };
}

/* Owner: ver notificaciones */
const loadEventsBtn = document.getElementById("loadEventsBtn");
if(loadEventsBtn){
  loadEventsBtn.onclick = async () => {
    const box = document.getElementById("eventsBox");
    box.textContent = "Cargando...";

    const { data, error } = await supabaseClient.rpc("get_recent_events", { p_limit: 30 });
    if(error){
      box.textContent = "âŒ " + (error.message || "Error");
      return;
    }

    const list = data || [];
    if(list.length === 0){
      box.textContent = "Sin notificaciones aÃºn.";
      return;
    }

    localStorage.setItem("eventsLastSeenId", String(list[0].id));
    await refreshNotifBadge();

    const mapType = (t) => {
      if(t === "CREDIT_ADD") return "â• CrÃ©ditos";
      if(t === "CREDIT_REMOVE") return "â– CrÃ©ditos";
      if(t === "MAKE_ADMIN") return "ğŸ‘‘ Dar admin";
      if(t === "REMOVE_ADMIN") return "âŒ Quitar admin";
      return t;
    };

    box.textContent = list.map(e => {
      const when = new Date(e.created_at).toLocaleString();
      const amt = (e.amount == null) ? "" : ` (${e.amount})`;
      const actor = e.actor_email ? ` | ${e.actor_email}` : "";
      return `${mapType(e.event_type)}${amt} â†’ ${e.target_email || ""}${actor}\n${when}\n`;
    }).join("\n");
  };
}


// BOTÃ“N ACTIVAR PUSH (OWNER)
const enablePushBtn = document.getElementById("enablePushBtn");
if (enablePushBtn) {
  enablePushBtn.onclick = async () => {
    await enablePushForOwner();
  };
}

function urlBase64ToUint8Array(base64String) {
  const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
  const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
  const rawData = atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; i++) outputArray[i] = rawData.charCodeAt(i);
  return outputArray;
}

async function enablePushForOwner(){
  const btn = document.getElementById("enablePushBtn");

  try{
    if(btn) btn.disabled = true;

    showPushModal("â³ Activando notificaciones...");

    // 0) Checks bÃ¡sicos
    if(!("serviceWorker" in navigator)){
      showPushModal("âŒ Este navegador no soporta Service Worker.");
      return;
    }
    if(!("PushManager" in window)){
      showPushModal("âŒ Este navegador no soporta Push (PushManager).");
      return;
    }

    // 1) En iOS: debe ser PWA instalada (icono en pantalla de inicio)
    const isStandalone =
      window.matchMedia("(display-mode: standalone)").matches ||
      window.navigator.standalone;

    if(!isStandalone){
      showPushModal(
        "ğŸ“² Para activar notificaciones en iPhone/iPad:\n\n" +
        "1) Safari â†’ Compartir â†’ 'Agregar a pantalla de inicio'\n" +
        "2) Abre la app desde el Ã­cono (NO desde Safari)\n" +
        "3) Vuelve a tocar 'Activar notificaciones'"
      );
      return;
    }

    // 2) Asegurar que el SW estÃ© registrado (EN RAÃZ)
    // âš ï¸ IMPORTANTE: /sw.js debe existir en https://TU-DOMINIO/sw.js
    const reg = await navigator.serviceWorker.register("/service-worker.js", { scope: "/" });
    await navigator.serviceWorker.ready;

    // 3) Permiso (en segundo click ya NO sale popup porque ya estÃ¡ granted)
    const perm = await Notification.requestPermission();
    if(perm !== "granted"){
      showPushModal("âŒ No concediste el permiso de notificaciones.");
      return;
    }

    // 4) SuscripciÃ³n push
    showPushModal("â³ Creando suscripciÃ³n push...");

    const readyReg = await navigator.serviceWorker.ready;

    // si ya existe, Ãºsala
    let sub = await readyReg.pushManager.getSubscription();

    const vapidPublicKey = "BIN1OWdYIaLHsghdp42zZBTXwLjHMGfJrd7GjsUpWiO6ujGLHB8M2Vq5QpbqKMQTIGf17BXRCvX7jP4h9JU67AU";
    const appServerKey = urlBase64ToUint8Array(vapidPublicKey);

    if(!sub){
      sub = await readyReg.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: appServerKey
      });
    }

    if(!sub){
      showPushModal("âŒ No se pudo crear la suscripciÃ³n (sub vacÃ­o).");
      return;
    }

    const json = sub.toJSON();
    if(!json?.endpoint || !json?.keys?.p256dh || !json?.keys?.auth){
      showPushModal("âŒ SuscripciÃ³n incompleta (faltan keys).");
      return;
    }

    // 5) Usuario logueado
    showPushModal("â³ Guardando en base de datos...");

    const { data: { user }, error: userErr } = await supabaseClient.auth.getUser();
    if(userErr || !user){
      showPushModal("âŒ No hay sesiÃ³n. Vuelve a iniciar sesiÃ³n.");
      return;
    }

    // 6) Guardar en tabla
    // âœ… IMPORTANTE: para upsert con onConflict, tu tabla debe tener UNIQUE(user_id)
    const payload = {
      user_id: user.id,
      endpoint: json.endpoint,
      p256dh: json.keys.p256dh,
      auth: json.keys.auth,
      created_at: new Date().toISOString()
    };

    const { error } = await supabaseClient
      .from("push_subscriptions")
      .upsert(payload, { onConflict: "user_id" });

    if(error){
      showPushModal("âŒ Error guardando en push_subscriptions:\n\n" + error.message);
      return;
    }

    showPushModal("âœ… Notificaciones activadas y registradas en la tabla.");
    if(btn) btn.textContent = "âœ… Notificaciones activadas";

  } catch(e){
    showPushModal("âŒ FallÃ³ activaciÃ³n:\n\n" + (e?.message || e));
    console.log("enablePushForOwner:", e);
  } finally {
    if(btn) btn.disabled = false;
  }
}






// =====================
// PUSH PARA TODOS (USER/ADMIN/OWNER)
// =====================
const VAPID_PUBLIC_KEY = "BIN1OWdYIaLHsghdp42zZBTXwLjHMGfJrd7GjsUpWiO6ujGLHB8M2Vq5QpbqKMQTIGf17BXRCvX7jP4h9JU67AU";

const pushBanner = document.getElementById("pushBanner");
const pushEnableBtn = document.getElementById("pushEnableBtn");

function urlBase64ToUint8Array(base64String) {
  const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
  const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
  const rawData = atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; i++) outputArray[i] = rawData.charCodeAt(i);
  return outputArray;
}

async function hasSubscriptionInDb(userId){
  // si tienes RLS, asegÃºrate que el usuario pueda leer su propia subs (policy)
  const { data, error } = await supabaseClient
    .from("push_subscriptions")
    .select("user_id")
    .eq("user_id", userId)
    .limit(1);

  if(error){
    console.log("No pude revisar push_subscriptions:", error);
    return false;
  }
  return (data && data.length > 0);
}

// muestra banner si falta activar
async function maybeShowPushBanner(){
  try{
    if(!("serviceWorker" in navigator)) return;

    const { data: { user } } = await supabaseClient.auth.getUser();
    if(!user) return;

    // iOS/Safari: push requiere PWA instalada
    const isStandalone = window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone;
    if(!isStandalone){
      // igual puedes mostrar el banner con el mensaje de "instala la app"
      pushBanner.style.display = "block";
      pushEnableBtn.onclick = () => showModal("ğŸ“² Para notificaciones en iPhone/iPad: Safari â†’ Compartir â†’ Agregar a pantalla de inicio.");
      return;
    }

    const perm = Notification.permission; // "default" | "granted" | "denied"
    const alreadyInDb = await hasSubscriptionInDb(user.id);

    if(perm !== "granted" || !alreadyInDb){
      pushBanner.style.display = "block";
    }else{
      pushBanner.style.display = "none";
    }
  }catch(e){
    console.log("maybeShowPushBanner error:", e);
  }
}

async function enablePushForAllUsers(){
  try{
    if(!("serviceWorker" in navigator)){
      showModal("âŒ Este navegador no soporta notificaciones.");
      return;
    }

    // iOS/Safari: PWA instalada
    const isStandalone = window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone;
    if(!isStandalone){
      showModal("ğŸ“² Para activar notificaciones, instala la app: Safari â†’ Compartir â†’ Agregar a pantalla de inicio.");
      return;
    }

    // pedir permiso (solo con click)
    const perm = await Notification.requestPermission();
    if(perm !== "granted"){
      showModal("âŒ Debes permitir notificaciones.");
      return;
    }

    const reg = await navigator.serviceWorker.ready;

    // si habÃ­a una subs vieja, bÃ³rrala
    const oldSub = await reg.pushManager.getSubscription();
    if(oldSub) await oldSub.unsubscribe();

    const appServerKey = urlBase64ToUint8Array(VAPID_PUBLIC_KEY);

    const sub = await reg.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: appServerKey
    });

    const json = sub.toJSON();
    const { data: { user } } = await supabaseClient.auth.getUser();
    if(!user) throw new Error("No hay usuario logueado.");

    // âœ… guarda 1 subs por usuario
    const { error } = await supabaseClient
      .from("push_subscriptions")
      .upsert({
        user_id: user.id,
        endpoint: json.endpoint,
        p256dh: json.keys.p256dh,
        auth: json.keys.auth,
        created_at: new Date().toISOString()
      }, { onConflict: "user_id" });

    if(error){
      showModal("âŒ No se pudo guardar suscripciÃ³n\n\n" + error.message);
      return;
    }

    showModal("âœ… Notificaciones activadas");
    pushBanner.style.display = "none";

  }catch(e){
    console.log("enablePushForAllUsers error:", e);
    showModal("âŒ Error activando notificaciones\n\n" + (e.message || e));
  }
}

// click del banner
if(pushEnableBtn){
  pushEnableBtn.onclick = async () => {
    await enablePushForAllUsers();
  };
}


</script>

</body>
</html>
